<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Escalabilidade - n8n</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .loadtest-page .panel-card { margin-bottom: 16px; }
        .loadtest-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .loadtest-form { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .loadtest-form label { font-size: 0.85rem; color: var(--muted); font-weight: 600; display:block; margin-bottom: 6px; }
        .loadtest-form input, .loadtest-form select { width:100%; }
        .loadtest-actions { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
        .loadtest-status { font-size: 0.9rem; color: var(--muted); }
        .loadtest-list { display:flex; flex-direction:column; gap:8px; max-height: 420px; overflow:auto; }
        .loadtest-item { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border-radius: 10px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); }
        .loadtest-item.ok { border-color: rgba(16,185,129,0.45); background: rgba(16,185,129,0.08); }
        .loadtest-item.err { border-color: rgba(239,68,68,0.45); background: rgba(239,68,68,0.08); }
        .loadtest-item .meta { font-size: 0.8rem; color: #cbd5f5; }
        .loadtest-kpi { background: rgba(8,12,28,0.6); border:1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 12px 14px; }
        .loadtest-kpi h3 { margin:0 0 6px; font-size: 0.9rem; color: #e2e8f0; }
        .loadtest-kpi .value { font-size: 1.3rem; font-weight: 700; color: #fff; }
        .loadtest-note { font-size:0.85rem; color:#94a3b8; }
    </style>
</head>
<body class="presentation-page loadtest-page">
    <div class="space-layer stars"></div>
    <div class="space-layer twinkle"></div>
    <div class="space-layer nebula"></div>
    <div class="space-layer galaxies"></div>

    <div class="page-wrapper">
        <div class="page-container">
            <header class="page-header">
                <div>
                    <h1>üö¶ Teste de Escalabilidade</h1>
                    <p class="subtitle">Envie v√°rias requisi√ß√µes e veja quais respondem ou n√£o.</p>
                </div>
            </header>

            <div class="navigation">
                <a href="index.html" class="nav-button"><i class="fas fa-calendar-alt"></i> Agenda</a>
                <a href="feedbacks.html" class="nav-button"><i class="fas fa-comment-dots"></i> Feedbacks</a>
                <a href="despesas.html" class="nav-button"><i class="fas fa-file-invoice-dollar"></i> Despesas</a>
                <a href="historico.html" class="nav-button"><i class="fas fa-history"></i> Hist√≥ricos</a>
                <a href="account.html" class="nav-button account-header-btn"><i class="fas fa-user-astronaut"></i> Minha Conta</a>
                <a href="rotas.html" class="nav-button"><i class="fas fa-route"></i> Rotas</a>
                <a href="debug.html" class="nav-button"><i class="fas fa-bug"></i> Debug</a>
            </div>

            <div class="panel-card">
                <div class="panel-title"><span>Configura√ß√£o do teste</span></div>
                <div class="loadtest-form">
                    <div>
                        <label for="lt-url">Webhook</label>
                        <input id="lt-url" type="text" value="https://urania-planetario-n8n.mmjkgs.easypanel.host/webhook/agenda-astronomos">
                    </div>
                    <div>
                        <label for="lt-action">Action</label>
                        <input id="lt-action" type="text" value="atualizar_agenda">
                    </div>
                    <div>
                        <label for="lt-total">Total de requisi√ß√µes</label>
                        <input id="lt-total" type="number" min="1" value="50">
                    </div>
                    <div>
                        <label for="lt-concurrency">Concorr√™ncia</label>
                        <input id="lt-concurrency" type="number" min="1" value="10">
                    </div>
                    <div>
                        <label for="lt-timeout">Timeout (ms)</label>
                        <input id="lt-timeout" type="number" min="1000" value="15000">
                    </div>
                    <div>
                        <label for="lt-use-session">Origem dos IDs</label>
                        <select id="lt-use-session">
                            <option value="yes" selected>Usu√°rio logado</option>
                            <option value="all">Todos os astr√¥nomos (painel RH)</option>
                            <option value="no">Sem IDs</option>
                        </select>
                        <div class="loadtest-note">Envia id_astronomo, id_visita, id_pre, id_reserva e id_n_marcar.</div>
                    </div>
                </div>
                <div class="loadtest-actions" style="margin-top:12px;">
                    <button id="lt-start" class="btn btn-primary">Iniciar teste</button>
                    <button id="lt-stop" class="btn btn-secondary" disabled>Parar</button>
                    <span class="loadtest-status" id="lt-status">Pronto.</span>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-title"><span>Resumo</span></div>
                <div class="loadtest-grid">
                    <div class="loadtest-kpi">
                        <h3>Total</h3>
                        <div class="value" id="lt-kpi-total">0</div>
                    </div>
                    <div class="loadtest-kpi">
                        <h3>Respondidas</h3>
                        <div class="value" id="lt-kpi-ok">0</div>
                    </div>
                    <div class="loadtest-kpi">
                        <h3>N√£o respondidas</h3>
                        <div class="value" id="lt-kpi-err">0</div>
                    </div>
                </div>
            </div>

            <div class="panel-card">
                <div class="panel-title"><span>Resultados</span></div>
                <div id="lt-list" class="loadtest-list"></div>
            </div>
        </div>
    </div>

    <script>
        const elUrl = document.getElementById('lt-url');
        const elAction = document.getElementById('lt-action');
        const elTotal = document.getElementById('lt-total');
        const elConcurrency = document.getElementById('lt-concurrency');
        const elTimeout = document.getElementById('lt-timeout');
        const elUseSession = document.getElementById('lt-use-session');
        const btnStart = document.getElementById('lt-start');
        const btnStop = document.getElementById('lt-stop');
        const elStatus = document.getElementById('lt-status');
        const elList = document.getElementById('lt-list');
        const kpiTotal = document.getElementById('lt-kpi-total');
        const kpiOk = document.getElementById('lt-kpi-ok');
        const kpiErr = document.getElementById('lt-kpi-err');

        let abortAll = false;
        let ASTRONOMOS = [];

        function findAstronomerFromCache(sess){
            try{
                const raw = localStorage.getItem('astronomersData');
                const list = raw ? JSON.parse(raw) : null;
                if (!Array.isArray(list) || !list.length) return null;
                const id = sess?.id_astronomo ?? sess?.assistant_id ?? sess?.id ?? null;
                const user = (sess?.usuario || sess?.username || sess?.astronomo || '').toString().trim().toLowerCase();
                return list.find(a => {
                    if (!a || typeof a !== 'object') return false;
                    const aId = a.id_astronomo ?? a.id ?? a.assistant_id ?? null;
                    if (id != null && String(aId) === String(id)) return true;
                    const aUser = (a.usuario || a.username || a.astronomo || '').toString().trim().toLowerCase();
                    return user && aUser && aUser === user;
                }) || null;
            }catch(_){
                return null;
            }
        }

        function getLoggedSession(){
            try{
                const raw = localStorage.getItem('astronomo_session');
                const s = raw ? JSON.parse(raw) : null;
                if (s && s.loggedIn !== false) return s;
            }catch(_){}
            return null;
        }

        async function fetchAstronomersList(){
            try{
                const resp = await fetch('https://urania-planetario-n8n.mmjkgs.easypanel.host/webhook/novo-astronomo-1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'list' })
                });
                const text = await resp.text().catch(() => '');
                if (!resp.ok) throw new Error(text || `HTTP ${resp.status}`);
                let data = null;
                try { data = text ? JSON.parse(text) : null; } catch (_) { data = null; }
                if (Array.isArray(data)) return data;
                if (data && Array.isArray(data.astronomos)) return data.astronomos;
                if (data && typeof data === 'object' && data.id_astronomo != null) return [data];
                return [];
            }catch(err){
                console.error('Falha ao carregar astr√¥nomos:', err);
                return [];
            }
        }

        function buildSessionPayload(){
            const sess = getLoggedSession();
            const cached = findAstronomerFromCache(sess);
            return { ...(cached || {}), ...(sess || {}) };
        }

        function getSessionTaskIds(sess){
            const parseId = (v) => {
                if (v === undefined || v === null || v === '') return null;
                const n = Number(v);
                if (Number.isFinite(n)) return String(n);
                const s = String(v).trim();
                return s || null;
            };
            return {
                visita: parseId(sess?.id_visita || sess?.visita_id),
                pre: parseId(sess?.id_pre || sess?.pre_id),
                reserva: parseId(sess?.id_reserva || sess?.reserva_id),
                nao_marcar: parseId(sess?.id_n_marcar || sess?.id_nao_marcar || sess?.nao_marcar_id)
            };
        }

        function buildPayload(action, overrideBase){
            const payload = { action };
            if (elUseSession.value !== 'yes') return payload;
            const base = overrideBase || buildSessionPayload();
            if (base && base.id_astronomo != null) payload.id_astronomo = base.id_astronomo;
            if (base && (base.usuario || base.username || base.astronomo)) {
                payload.usuario = base.usuario || base.username || base.astronomo;
            }
            const ids = getSessionTaskIds(base || null);
            if (ids.visita) payload.id_visita = ids.visita;
            if (ids.pre) payload.id_pre = ids.pre;
            if (ids.reserva) payload.id_reserva = ids.reserva;
            if (ids.nao_marcar) payload.id_n_marcar = ids.nao_marcar;
            return payload;
        }

        function updateKpis(total, ok, err){
            kpiTotal.textContent = total.toString();
            kpiOk.textContent = ok.toString();
            kpiErr.textContent = err.toString();
        }

        function addResultItem(idx, ok, status, ms){
            const row = document.createElement('div');
            row.className = `loadtest-item ${ok ? 'ok' : 'err'}`;
            row.innerHTML = `
                <div><strong>#${idx + 1}</strong> ${ok ? 'Requisi√ß√£o respondida' : 'N√£o respondida'}</div>
                <div class="meta">${status} ¬∑ ${ms} ms</div>
            `;
            elList.prepend(row);
        }

        async function sendOne(idx, url, action, timeoutMs, basePayload){
            const controller = new AbortController();
            const t = setTimeout(() => controller.abort(), timeoutMs);
            const started = performance.now();
            try{
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildPayload(action, basePayload)),
                    signal: controller.signal
                });
                const ms = Math.round(performance.now() - started);
                return { ok: resp.ok, status: resp.status, ms };
            }catch(err){
                const ms = Math.round(performance.now() - started);
                return { ok: false, status: 'ERR', ms };
            }finally{
                clearTimeout(t);
            }
        }

        async function runTest(){
            abortAll = false;
            elList.innerHTML = '';
            const total = Math.max(1, Number(elTotal.value) || 1);
            const concurrency = Math.max(1, Number(elConcurrency.value) || 1);
            const timeoutMs = Math.max(1000, Number(elTimeout.value) || 15000);
            const url = elUrl.value.trim();
            const action = elAction.value.trim() || 'atualizar_agenda';
            const useAllAstronomers = elUseSession.value === 'all';

            if (useAllAstronomers) {
                elStatus.textContent = 'Carregando astr√¥nomos do painel RH...';
                ASTRONOMOS = await fetchAstronomersList();
                if (!ASTRONOMOS.length) {
                    elStatus.textContent = 'N√£o foi poss√≠vel carregar astr√¥nomos do painel RH.';
                    return;
                }
            }

            let ok = 0;
            let err = 0;
            updateKpis(total, ok, err);
            elStatus.textContent = `Executando ${total} requisi√ß√µes com concorr√™ncia ${concurrency}...`;
            btnStart.disabled = true;
            btnStop.disabled = false;

            let idx = 0;
            while (idx < total && !abortAll) {
                const batch = [];
                for (let i = 0; i < concurrency && idx < total; i++, idx++) {
                    const basePayload = useAllAstronomers
                        ? ASTRONOMOS[idx % ASTRONOMOS.length]
                        : null;
                    batch.push(sendOne(idx, url, action, timeoutMs, basePayload).then((res) => ({ res, seq: idx })));
                }
                const results = await Promise.all(batch);
                results.forEach(({ res, seq }) => {
                    if (res.ok) ok += 1; else err += 1;
                    addResultItem(seq - 1, res.ok, res.status, res.ms);
                });
                updateKpis(total, ok, err);
            }

            elStatus.textContent = abortAll ? 'Teste interrompido.' : 'Teste conclu√≠do.';
            btnStart.disabled = false;
            btnStop.disabled = true;
        }

        btnStart.addEventListener('click', runTest);
        btnStop.addEventListener('click', () => { abortAll = true; });
    </script>
</body>
</html>
